name: Deploy Next.js Landing

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v0.1.9
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: 22
          script: |
            set -e  # Sale si hay cualquier error

            echo "ðŸš€ Entrando a /var/www..."
            cd /var/www/

            # Si ya existe, hacemos git pull; si no, clonamos
            if [ -d spsolutions.app ]; then
              echo "ðŸ”„ Actualizando repositorio existente..."
              cd spsolutions.app
              git fetch --all
              git reset --hard origin/main
            else
              echo "ðŸ“¦ Clonando repositorio por primera vez..."
              git clone https://${{ secrets.GH_TOKEN }}@github.com/spsolutionsapps/crm-website.git spsolutions.app
              cd spsolutions.app
            fi

            echo "ðŸ“„ Copiando variables de entorno..."
            if [ -f /etc/spsolutions.app/.env.production ]; then
              cp /etc/spsolutions.app/.env.production .env
            else
              echo "âš ï¸ .env.production no encontrado. Verifica en /etc/spsolutions.app/"
            fi

            echo "ðŸ›  Instalando dependencias..."
            npm install --legacy-peer-deps

            echo "âš¡ Forzando que Next.js y SWC coincidan..."
            npm install @next/swc@15.5.11

            echo "âœ¨ Instalando Tailwind postcss plugin si falta..."
            npm install @tailwindcss/postcss

            echo "ðŸ— Construyendo la app..."
            npm run build

            echo "ðŸ”„ Reiniciando PM2..."
            pm2 delete nextjs 2>/dev/null || true
            PORT=3000 pm2 start npm --name nextjs -- start
            pm2 save

            echo "âœ… Deploy finalizado correctamente"
